<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>第十九部分 改变之前的想法 &mdash; Twisted 入门|Twisted Introduction</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="top" title="Twisted 入门|Twisted Introduction" href="index.html" />
    <link rel="next" title="第二十部分 轮子中的轮子: Twisted和Erlang" href="p20.html" />
    <link rel="prev" title="第十八部分 Deferreds 全貌" href="p18.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>Twisted Introduction</span></a></h1>
        <h2 class="heading"><span>第十九部分 改变之前的想法</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="p18.html">第十八部分 Deferreds 全貌</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">目录</a>
        &#160;&#160;::&#160;&#160;
        <a href="p20.html">第二十部分 轮子中的轮子: Twisted和Erlang</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="id1">
<h1>第十九部分 改变之前的想法<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<p>你可以从 &#8220;<a class="reference internal" href="p01.html"><em>第一部分 Twist理论基础</em></a>&#8221; 开始阅读；也可以从 &#8220;<a class="reference internal" href="index.html"><em>Twisted 入门!</em></a>&#8221; 浏览索引.</p>
<div class="section" id="id2">
<h2>简介<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<div class="line-block">
<div class="line">Twisted是一个正在进展的项目,它的开发者会定期添加新的特性并且扩展旧的特性.</div>
<div class="line">随着Twisted 10.1.0发布,开发者向 <tt class="docutils literal"><span class="pre">Deferred</span></tt> 类添加了一个新的特性—— <tt class="docutils literal"><span class="pre">cancellation</span></tt> ——这正是我们今天要研究的.</div>
</div>
<p>异步编程将请求和响应解耦了,如此又带来一个新的可能性:在请求结果和返回结果之间,你可能决定不再需要这个结果了.考虑一下 <a class="reference internal" href="p14.html"><em>第十四部分 Deferred用于同步环境</em></a> 中的诗歌代理服务器.下面是这个如何工作的,至少对于诗歌的第一次请求:</p>
<ol class="arabic simple">
<li>一个对诗歌的请求来了.</li>
<li>这个代理联系实际服务器以得到这首诗</li>
<li>一旦这首诗完成,将其发送给原发出请求的代理</li>
</ol>
<p>看起来非常完美,但是如果客户端在获得诗歌之前挂了怎么办?也许它们先前请求 <a class="reference external" href="http://www.online-literature.com/milton/paradiselost/">Paradise Lost</a> 的全部内容,随后它们决定实际想要的是 <a class="reference external" href="http://www.toyomasu.com/haiku/#kojo">Kojo</a> 的俳句.我们的代理将陷入下载前者,并且那个慢服务器会等好一会.最好的策略便是关闭连接,让慢服务器回去顺觉.</p>
<p>回忆一下 <em class="xref std std-ref">figure15</em>,展示了同步程序控制流的概念.在那张图中我们可以看到函数调用自上而下,异常是自下而上.如果我们希望取消一个同步调用(这仅是假设),控制流的传递方向与函数调用的方向一致,都是从高层传向底层,如图38所示:</p>
<div class="figure" id="figure38">
<img alt="_images/p19_sync-cancel.png" src="_images/p19_sync-cancel.png" />
</div>
<div class="line-block">
<div class="line">图38:同步程序流,含假想取消操作</div>
</div>
<p>当然,在同步程序中这是不可能的,因为高层的代码在底层操作结束前没有恢复运行,自然也就没有什么可取消的.但是在异步程序中,高层代码在底层代码完成前具有控制权,至少具有在底层代码完成之前取消它的请求的可能性.</p>
<p>在Twisted程序中,底层请求被包含在一个 <tt class="docutils literal"><span class="pre">Deferred</span></tt> 对象中,你可以将其想象为一个外部异步操作的&#8221;句柄&#8221;. <tt class="docutils literal"><span class="pre">deferred</span></tt> 中正常的信息流是向下的,从底层代码到高层代码,与同步程序中返回的信息流方向一致.从Twisted 10.1.0开始,高层代码可以反向发送信息 —— 它可以告诉底层代码它不再需要其结果了.如图39:</p>
<div class="figure" id="figure39">
<img alt="_images/p19_deferred-cancel.png" src="_images/p19_deferred-cancel.png" />
</div>
<div class="line-block">
<div class="line">图39： <tt class="docutils literal"><span class="pre">deferred</span></tt> 中的信息流,包含取消</div>
</div>
</div>
<div class="section" id="deferreds">
<h2>取消 <tt class="docutils literal"><span class="pre">Deferreds</span></tt><a class="headerlink" href="#deferreds" title="永久链接至标题">¶</a></h2>
<p>让我们看一些例程,来了解下取消 <tt class="docutils literal"><span class="pre">deferreds</span></tt> 的实际工作原理.注:为了运行这些列子以及本部分中的其他代码,你需要安装Twisted 10.1.0或更高 <a class="reference external" href="http://twistedmatrix.com/trac/wiki/Downloads">版本</a>. 考虑 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-1.py#L1">deferred-cancel/defer-cancel-1.py</a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;callback got:&#39;</span><span class="p">,</span> <span class="n">res</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">Deferred</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&#39;done&#39;</span>
</pre></div>
</div>
<p>伴随着新的取消特性, <tt class="docutils literal"><span class="pre">Deferred</span></tt> 类获得一个名为 <tt class="docutils literal"><span class="pre">cancel</span></tt> 的新方法.上面代码创建了一个新的 <tt class="docutils literal"><span class="pre">deferred</span></tt>,添加了一个回调,这后取消了这个 <tt class="docutils literal"><span class="pre">deferred</span></tt> 而没有激发它.输出如下:</p>
<div class="highlight-python"><pre>done
Unhandled error in Deferred:
Traceback (most recent call last):
Failure: twisted.internet.defer.CancelledError:</pre>
</div>
<p>OK,取消一个 <tt class="docutils literal"><span class="pre">deferred</span></tt> 看起来像使错误回调链运行,常规的回调根本没有被调用.同样注意到这个错误是: <cite>twisted.internet.defer.CancelledError</cite>,一个意味着 <tt class="docutils literal"><span class="pre">deferred</span></tt> 被取消的个性化异常(但请继续阅读).让我们添加一个错误回调,如 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-2.py#L1">deferred-cancel/defer-cancel-2.py</a></p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;callback got:&#39;</span><span class="p">,</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">errback</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;errback got:&#39;</span><span class="p">,</span> <span class="n">err</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">Deferred</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">errback</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&#39;done&#39;</span>
</pre></div>
</div>
<p>得到以下输出:</p>
<div class="highlight-python"><pre>errback got: [Failure instance: Traceback (failure with no frames): &lt;class 'twisted.internet.defer.CancelledError'&gt;:
]
done</pre>
</div>
<p>所以我们可以&#8217;捕获&#8217;从 <tt class="docutils literal"><span class="pre">cancel</span></tt> 产生的错误回调,就像其他 <tt class="docutils literal"><span class="pre">deferred</span></tt> 错误一样.</p>
<p>OK,让我们试试激发 <tt class="docutils literal"><span class="pre">deferred</span></tt> 然后取消它,如 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-3.py#L1">deferred-cancel/defer-cancel-3.py</a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;callback got:&#39;</span><span class="p">,</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">errback</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;errback got:&#39;</span><span class="p">,</span> <span class="n">err</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">Deferred</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">errback</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="s">&#39;result&#39;</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&#39;done&#39;</span>
</pre></div>
</div>
<p>这里我们用常规 <tt class="docutils literal"><span class="pre">callback</span></tt> 方法激发 <tt class="docutils literal"><span class="pre">deferred</span></tt>,之后取消它.输出结果如下:</p>
<div class="highlight-python"><pre>callback got: result
done</pre>
</div>
<p>我们的回调被调用(正如我们所预期的)之后程序正常结束,就像 <tt class="docutils literal"><span class="pre">cancel</span></tt> 根本没有被调用.所以取消一个 <tt class="docutils literal"><span class="pre">deferred</span></tt> 好像根本没有效果如果它已经被激发(但请继续阅读!).</p>
<p>如果我们在取消 <tt class="docutils literal"><span class="pre">deferred</span></tt> 之后激发它会怎样?参看 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-4.py#L1">deferred-cancel/defer-cancel-4.py</a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;callback got:&#39;</span><span class="p">,</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">errback</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;errback got:&#39;</span><span class="p">,</span> <span class="n">err</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">Deferred</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">errback</span><span class="p">)</span>
<span class="n">d</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<span class="n">d</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="s">&#39;result&#39;</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&#39;done&#39;</span>
</pre></div>
</div>
<p>这种情况的输出如下:</p>
<div class="highlight-python"><pre>errback got: [Failure instance: Traceback (failure with no frames): &lt;class 'twisted.internet.defer.CancelledError'&gt;:
]
done</pre>
</div>
<p>有意思！与第二个例子的输出一样,当时没有激发 <tt class="docutils literal"><span class="pre">deferred</span></tt>.所以如果 <tt class="docutils literal"><span class="pre">deferred</span></tt> 被取消了,再激发它没有效果.但是为什么 <cite>d.callback(&#8216;result&#8217;)</cite> 没有产生错误,考虑到不能激发 <tt class="docutils literal"><span class="pre">deferred</span></tt> 大于一次,错误回调链为何没有运行?</p>
<p>再次考虑 <a class="reference internal" href="#figure39">figure39</a>.用结果或失败激发一个 <tt class="docutils literal"><span class="pre">deferred</span></tt> 是底层代码的工作,然而取消 <tt class="docutils literal"><span class="pre">deferred</span></tt> 是高层代码的行为.激发 <tt class="docutils literal"><span class="pre">deferred</span></tt> 意味着&#8221;这是你的结果&#8221;,然而取消 <tt class="docutils literal"><span class="pre">deferred</span></tt> 意味着&#8221;我不再想要这个结果了&#8221;.同时记住 <tt class="docutils literal"><span class="pre">cancel</span></tt> 是一个新特性,所以大部分现有的Twisted代码并没有处理取消的操作.但是Twisted的开发者使我们取消 <tt class="docutils literal"><span class="pre">deferred</span></tt> 的想法变得有可能,甚至包括那些在Twisted 10.1.0之前写的代码.</p>
<p>为了实现以上想法, <tt class="docutils literal"><span class="pre">cancel</span></tt> 方法实际上做两件事:</p>
<ol class="arabic simple">
<li>告诉 <tt class="docutils literal"><span class="pre">Deferred</span></tt> 对象本身你不想要那个结果,如果它还没有返回(如, <tt class="docutils literal"><span class="pre">deferred</span></tt> 没有被激发),这样忽略任何回调或错误回调的后续调用.</li>
<li>同时,可选地,告诉正在产生结果的底层代码需要采取何种步骤来取消操作.</li>
</ol>
<p>由于旧版本的Twisted代码会上前去激发任何已经被取消的 <tt class="docutils literal"><span class="pre">deferred</span></tt>, step#1确保我们的程序不会垮掉如果我们取消一个旧有库中的 <tt class="docutils literal"><span class="pre">deferred</span></tt>.</p>
<p>这意味着我们可以随心所欲地取消一个 <tt class="docutils literal"><span class="pre">deferred</span></tt>,同时可以确定不会得到结果如果它还没有到来(甚至那些 <strong>将要</strong> 到来的).但是取消 <tt class="docutils literal"><span class="pre">deferred</span></tt> 可能并没有取消异步操作.终止一个异步操作需要一个上下文的具体行动.你可能需要关闭网络连接,回滚数据库事务,结束子进程,等等.由于 <tt class="docutils literal"><span class="pre">deferred</span></tt> 仅仅是一般目的的回调组织者,它怎么知道具体要做什么当你取消它时?或者,换种说法,它怎样将 <tt class="docutils literal"><span class="pre">cancel</span></tt> 请求传递给首先已经创建和返回了 <tt class="docutils literal"><span class="pre">deferred</span></tt> 的底层代码? 和我一起说:</p>
<div class="highlight-python"><pre>I know, with a callback!</pre>
</div>
</div>
<div class="section" id="id4">
<h2>本质上取消 <tt class="docutils literal"><span class="pre">Deferreds</span></tt><a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>好吧,首先看一下 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-5.py#L1">deferred-cancel/defer-cancel-5.py</a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span>

<span class="k">def</span> <span class="nf">canceller</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;I need to cancel this deferred:&quot;</span><span class="p">,</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;callback got:&#39;</span><span class="p">,</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">errback</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;errback got:&#39;</span><span class="p">,</span> <span class="n">err</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">Deferred</span><span class="p">(</span><span class="n">canceller</span><span class="p">)</span> <span class="c"># created by lower-level code</span>
<span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">errback</span><span class="p">)</span> <span class="c"># added by higher-level code</span>
<span class="n">d</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&#39;done&#39;</span>
</pre></div>
</div>
<p>这个例子基本上跟第二个例子相同,除了有第三个回调(<tt class="docutils literal"><span class="pre">canceller</span></tt>).这个回调是我们在创建 <tt class="docutils literal"><span class="pre">Deferred</span></tt> 的时候传递给它的,不是之后添加的.这个回调负责执行终止异步操作时所需的上下文相关的具体操作(当然,仅当 <tt class="docutils literal"><span class="pre">deferred</span></tt> 被实际取消). <tt class="docutils literal"><span class="pre">canceller</span></tt> 回调是返回 <tt class="docutils literal"><span class="pre">deferred</span></tt>  的底层代码的必要部分,不是接收 <tt class="docutils literal"><span class="pre">deferred</span></tt> 的高层代码为其自己添加的回调和错误回调.</p>
<p>运行这个例子将产生如下输出:</p>
<div class="highlight-python"><pre>I need to cancel this deferred: &lt;Deferred at 0xb7669d2cL&gt;
errback got: [Failure instance: Traceback (failure with no frames): &lt;class 'twisted.internet.defer.CancelledError'&gt;:
]
done</pre>
</div>
<p>正如你所看到, 不需要返回结果的 <tt class="docutils literal"><span class="pre">deferred</span></tt> 被传递给 <tt class="docutils literal"><span class="pre">canceller</span></tt> 回调.在这里我们可以做任何需要做的事情以便彻底终止异步操作.注意 <tt class="docutils literal"><span class="pre">canceller</span></tt> 在错误回调链激发前被调用.其实我们可以在取消回调中选择使用任何结果或错误自己激发 <tt class="docutils literal"><span class="pre">deferred</span></tt> (这样就会优先于 <tt class="docutils literal"><span class="pre">CancelledError</span></tt> 失败).这两种情况在 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-6.py#L1">deferred-cancel/defer-cancel-6.py</a>  和 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-7.py#L1">deferred-cancel/defer-cancel-7.py</a> 中进行了说明.</p>
<p>在激发 <tt class="docutils literal"><span class="pre">reactor</span></tt> 之前先做一个简单的测试.我们将使用 <tt class="docutils literal"><span class="pre">canceller</span></tt> 回调创建一个 <tt class="docutils literal"><span class="pre">deferred</span></tt>,正常的激发它,之后取消它.你可以在 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-8.py#L1">deferred-cancel/defer-cancel-8.py</a> 中看到代码.通过检查那个脚本的输出,你将看到取消一个被激发的 <tt class="docutils literal"><span class="pre">deferred</span></tt> 不会调用 <tt class="docutils literal"><span class="pre">canceller</span></tt> 回调.这正是我们所要的,因为没什么可取消的.</p>
<div class="line-block">
<div class="line">我们目前看到的例子都没有实际的异步操作. 让我们构造一个调用异步操作的简单程序,之后我们将指出如何使那个操作可取消.</div>
<div class="line">参见代码 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-9.py#L1">deferred-cancel/defer-cancel-9.py</a>:</div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">twisted.internet.defer</span> <span class="kn">import</span> <span class="n">Deferred</span>

<span class="k">def</span> <span class="nf">send_poem</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;Sending poem&#39;</span>
    <span class="n">d</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="s">&#39;Once upon a midnight dreary&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_poem</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return a poem 5 seconds later.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">()</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">send_poem</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>

<span class="k">def</span> <span class="nf">got_poem</span><span class="p">(</span><span class="n">poem</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;I got a poem:&#39;</span><span class="p">,</span> <span class="n">poem</span>

<span class="k">def</span> <span class="nf">poem_error</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;get_poem failed:&#39;</span><span class="p">,</span> <span class="n">err</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
    <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span> <span class="c"># stop the reactor in 10 seconds</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">get_poem</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">got_poem</span><span class="p">,</span> <span class="n">poem_error</span><span class="p">)</span>

    <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>这个例子中包含了一个 <cite>get_poem</cite> 函数,它使用 <tt class="docutils literal"><span class="pre">reactor</span></tt> 的 <tt class="docutils literal"><span class="pre">callLater</span></tt> 方法在被调用5秒钟后异步地返回一首诗.主函数调用 <cite>get_poem</cite>,添加一个回调/错误回调对,之后启动 <tt class="docutils literal"><span class="pre">reactor</span></tt>.我们(同样使用 <tt class="docutils literal"><span class="pre">callLater</span></tt>)安排 <tt class="docutils literal"><span class="pre">reactor</span></tt> 在10秒钟之后停止.通常我们向 <tt class="docutils literal"><span class="pre">deferred</span></tt> 添加一个回调来实现,但你很快就会知道我们为何这样做.</p>
<p>运行程序(适当延迟后)产生如下输出:</p>
<div class="highlight-python"><pre>Sending poem
I got a poem: Once upon a midnight dreary</pre>
</div>
<p>10秒钟后程序终止.现在来试试在诗歌被发送前取消 <tt class="docutils literal"><span class="pre">deferred</span></tt>.只需加入以下代码在2秒钟后取消(在5秒钟延迟发送诗歌之前):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span> <span class="c"># cancel after 2 seconds</span>
</pre></div>
</div>
<p>完整的例子参见 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-10.py#L1">deferred-cancel/defer-cancel-10.py</a>,这将产生如下输出:</p>
<div class="highlight-python"><pre>get_poem failed: [Failure instance: Traceback (failure with no frames): &lt;class 'twisted.internet.defer.CancelledError'&gt;:
]
Sending poem</pre>
</div>
<p>这个例子清晰地展示了取消一个 <tt class="docutils literal"><span class="pre">deferred</span></tt> 并没有取消它背后的异步请求.2秒钟后我们看到了错误回调输出,打印出如我们所料的 <tt class="docutils literal"><span class="pre">CancelledError</span></tt> 错误.但是5秒钟后我们看到了 <cite>send_poem</cite> 的输出(但是这个 <tt class="docutils literal"><span class="pre">deferred</span></tt> 上的回调并没有激发).</p>
<p>这时我们与 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-4.py#L1">deferred-cancel/defer-cancel-4.py</a> 的情况一样.&#8221;取消&#8221; <tt class="docutils literal"><span class="pre">deferred</span></tt> 仅仅是使最终结果被忽略,但实际上并没有终止这个操作.正如我们上面所学,为了得到一个真正可取消的 <tt class="docutils literal"><span class="pre">deferred</span></tt>,必须在它被创建时添加一个 <tt class="docutils literal"><span class="pre">cancel</span></tt> 回调.</p>
<p>那么这个新的回调需要做什么呢? 参考一下关于 <tt class="docutils literal"><span class="pre">callLater</span></tt> 方法的 <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/interfaces.py#L556">文档</a>. 它的返回值是另一个实现了 <tt class="docutils literal"><span class="pre">IDelayedCall</span></tt> 的对象,用 <tt class="docutils literal"><span class="pre">cancel</span></tt> 方法我们可以阻止延迟的调用被执行.</p>
<p>这非常简单,更新后的代码参见 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-11.py#L1">deferred-cancel/defer-cancel-11.py</a>.所有相关变化都在 <cite>get_poem</cite> 函数中:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_poem</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return a poem 5 seconds later.&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">canceler</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="c"># They don&#39;t want the poem anymore, so cancel the delayed call</span>
    <span class="n">delayed_call</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="c"># At this point we have three choices:</span>
    <span class="c">#   1. Do nothing, and the deferred will fire the errback</span>
    <span class="c">#      chain with CancelledError.</span>
    <span class="c">#   2. Fire the errback chain with a different error.</span>
    <span class="c">#   3. Fire the callback chain with an alternative result.</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">(</span><span class="n">canceler</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
<span class="n">delayed_call</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">send_poem</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

<span class="k">return</span> <span class="n">d</span>
</pre></div>
</div>
<p>在这个新版本中,我们保存 <tt class="docutils literal"><span class="pre">callLater</span></tt> 的返回值以便能够在 <tt class="docutils literal"><span class="pre">cancel</span></tt> 回调中使用. <tt class="docutils literal"><span class="pre">cancel</span></tt> 回调的唯一工作是调用 <cite>delayed_call.cancel()</cite>. 但是正如之前讨论的,我们可以选择激发自定义的 <tt class="docutils literal"><span class="pre">deferred</span></tt>. 最新版本的程序产生如下输出:</p>
<div class="highlight-python"><pre>get_poem failed: [Failure instance: Traceback (failure with no frames): &lt;class 'twisted.internet.defer.CancelledError'&gt;:
]</pre>
</div>
<p>正如你看到的, <tt class="docutils literal"><span class="pre">deferred</span></tt> 被取消了并且异步操作被真正地终止了(我们看不到 <cite>send_poem</cite> 的输出了).</p>
</div>
<div class="section" id="id7">
<h2>诗歌代理 3.0<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<p>正如在简介中所讨论,诗歌代理服务器是实现取消的很好的候选者,因为这可以让我们取消诗歌下载如果事实证明没有人想要它(如客户端已经在我们发送诗歌前关闭了连接).版本 3.0的代理位于 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-4/poetry-proxy.py#L1">twisted-server-4/poetry-proxy.py</a>,实现了 <tt class="docutils literal"><span class="pre">deferred</span></tt> 取消. 变化首先位于 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-4/poetry-proxy.py#L52">PoetryProxyProtocol</a>:</p>
<div class="highlight-python"><pre>class PoetryProxyProtocol(Protocol):

    def connectionMade(self):
        self.deferred = self.factory.service.get_poem()
        self.deferred.addCallback(self.transport.write)
        self.deferred.addBoth(lambda r: self.transport.loseConnection())

   def connectionLost(self, reason):
       if self.deferred is not None:
           deferred, self.deferred = self.deferred, None
           deferred.cancel() # cancel the deferred if it hasn't fired</pre>
</div>
<p>你可以与 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-2/poetry-proxy.py#L52">旧版本</a> 对比一下.两个主要的变化是:</p>
<ol class="arabic simple">
<li>保存我们从 <cite>get_poem</cite> 得到的 <tt class="docutils literal"><span class="pre">deferred</span></tt>,以便之后在需要时取消它.</li>
<li>当连接关闭时取消 <tt class="docutils literal"><span class="pre">deferred</span></tt>.注这个操作同样会取消 <tt class="docutils literal"><span class="pre">deferred</span></tt> 当我们实际得到诗歌之后,但正如前例所发现的,取消一个被激发的 <tt class="docutils literal"><span class="pre">deferred</span></tt> 不会有任何效果.</li>
</ol>
<p>现在我们需要确保取消 <tt class="docutils literal"><span class="pre">deferred</span></tt> 将实际终止诗歌的下载. 所以我们需要改变 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-4/poetry-proxy.py#L105">ProxyService</a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ProxyService</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">poem</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># the cached poem</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>

    <span class="k">def</span> <span class="nf">get_poem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">poem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
           <span class="k">print</span> <span class="s">&#39;Using cached poem.&#39;</span>
           <span class="c"># return an already-fired deferred</span>
           <span class="k">return</span> <span class="n">succeed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poem</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">canceler</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&#39;Canceling poem download.&#39;</span>
            <span class="n">factory</span><span class="o">.</span><span class="n">deferred</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">connector</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

        <span class="k">print</span> <span class="s">&#39;Fetching poem from server.&#39;</span>
        <span class="n">deferred</span> <span class="o">=</span> <span class="n">Deferred</span><span class="p">(</span><span class="n">canceler</span><span class="p">)</span>
        <span class="n">deferred</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_poem</span><span class="p">)</span>
        <span class="n">factory</span> <span class="o">=</span> <span class="n">PoetryClientFactory</span><span class="p">(</span><span class="n">deferred</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
        <span class="n">connector</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">connectTCP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">factory</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">factory</span><span class="o">.</span><span class="n">deferred</span>

    <span class="k">def</span> <span class="nf">set_poem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poem</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poem</span> <span class="o">=</span> <span class="n">poem</span>
        <span class="k">return</span> <span class="n">poem</span>
</pre></div>
</div>
<p>同样,可以与 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-2/poetry-proxy.py#100">旧版本</a> 对比一下. 这个类具有一些新的变化:</p>
<ol class="arabic simple">
<li>我们保存 <cite>reactor.connetTCP</cite> 的返回值,一个 <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/interfaces.py#L24">IConnector</a> 对象.我们可以使用这个对象上的 <tt class="docutils literal"><span class="pre">disconnect</span></tt> 方法关闭连接.</li>
<li>我们创建带 <tt class="docutils literal"><span class="pre">canceler</span></tt> 回调的 <tt class="docutils literal"><span class="pre">deferred</span></tt>.那个回调是一个闭包,它使用 <tt class="docutils literal"><span class="pre">connector</span></tt> 关闭连接. 但首先须设置 <cite>factory.deferred</cite> 属性为 <cite>None</cite>. 否则,工厂会以 &#8220;连接关闭&#8221;错误回调激发 <tt class="docutils literal"><span class="pre">deferred</span></tt> 而不是以 <tt class="docutils literal"><span class="pre">CancelledError</span></tt> 激发. 由于 <tt class="docutils literal"><span class="pre">deferred</span></tt> 已经被取消了, 以 <tt class="docutils literal"><span class="pre">CancelledError</span></tt> 激发更加合适.</li>
</ol>
<p>你同样会注意到我们是在 <tt class="docutils literal"><span class="pre">ProxyService</span></tt> 中创建 <tt class="docutils literal"><span class="pre">deferred</span></tt> 而不是 <tt class="docutils literal"><span class="pre">PoetryClientFactory</span></tt>. 由于 <tt class="docutils literal"><span class="pre">canceler</span></tt> 回调需要获取 <tt class="docutils literal"><span class="pre">IConnector</span></tt> 对象, <tt class="docutils literal"><span class="pre">ProxyService</span></tt> 成为最方便创建 <tt class="docutils literal"><span class="pre">deferred</span></tt> 的地方.</p>
<p>同时,就像我们之前的例子, <tt class="docutils literal"><span class="pre">canceler</span></tt> 回调作为一个闭包实现.闭包看起来在取消回调的实现上非常有用.</p>
<p>让我们试试新的代理.首先启动一个慢服务器.它需要很慢以便我们有时间取消:</p>
<div class="highlight-python"><pre>python blocking-server/slowpoetry.py --port 10001 poetry/fascination.txt</pre>
</div>
<p>现在可以启动代理(记住你需要Twisted 10.1.0):</p>
<div class="highlight-python"><pre>python twisted-server-4/poetry-proxy.py --port 10000 10001</pre>
</div>
<p>现在我们可以用任何客户端从代理下载一首诗,或者仅使用 <cite>curl</cite>:</p>
<div class="highlight-python"><pre>curl localhost:10000</pre>
</div>
<p>几秒钟后,按 <tt class="docutils literal"><span class="pre">Ctrl-C</span></tt> 停止客户端或者 <cite>curl</cite> 进程. 在终端运行代理你将看到如下输出:</p>
<div class="highlight-python"><pre>Fetching poem from server.
Canceling poem download.</pre>
</div>
<div class="line-block">
<div class="line">你应该看到慢服务器已经停止了向输出打印它所发送诗歌的片段,因为我们的代理挂了.</div>
<div class="line">你可以多次启动和停止客户端来证实每个下载每次都被取消了.但是如果你让整首诗运行完,那么代理将缓存它并且在此之后立即发送它.</div>
</div>
</div>
<div class="section" id="id10">
<h2>另一个难点<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h2>
<p>以上我们曾不止一次说取消一个已经激发的 <tt class="docutils literal"><span class="pre">deferred</span></tt> 是没有效果的.然而,这不是十分正确.在 <a class="reference internal" href="p13.html"><em>第十三部分 使用Deferred新功能实现新客户端</em></a> 中,我们学习了附加给一个 <tt class="docutils literal"><span class="pre">deferred</span></tt> 的回调和错误回调也可能返回另一个 <tt class="docutils literal"><span class="pre">deferred</span></tt>.在那种情况下,原始的(外层) <tt class="docutils literal"><span class="pre">deferred</span></tt> 暂停执行它的回调链并且等待内层 <tt class="docutils literal"><span class="pre">deferred</span></tt> 激发(参见 <a href="#id18"><span class="problematic" id="id19">`figure28`_</span></a>).</p>
<p>如此, 即使一个 <tt class="docutils literal"><span class="pre">deferred</span></tt> 激发了发出异步请求的高层代码,它也不能接收到结果,因为在等待内层 <tt class="docutils literal"><span class="pre">deferred</span></tt> 完成之前回调链暂停了. 所以当高层代码取消这个外部 <tt class="docutils literal"><span class="pre">deferred</span></tt> 时会发生什么情况呢? 在这种情况下,外部 <tt class="docutils literal"><span class="pre">deferred</span></tt> 不仅仅是取消它自己(它已经激发了);相反地,这个 <tt class="docutils literal"><span class="pre">deferred</span></tt> 取消内部的 <tt class="docutils literal"><span class="pre">deferred</span></tt>.</p>
<p>所以当你取消一个 <tt class="docutils literal"><span class="pre">deferred</span></tt> 时,你可能不是在取消主异步操作,而是一些其他的作为前者结果所触发的异步操作.呼!</p>
<p>我们可以用一个例子来说明.考虑代码 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/deferred-cancel/defer-cancel-12.py#L1">deferred-cancel/defer-cancel-12.py</a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span>

<span class="k">def</span> <span class="nf">cancel_outer</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;outer cancel callback.&quot;</span>

<span class="k">def</span> <span class="nf">cancel_inner</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;inner cancel callback.&quot;</span>

<span class="k">def</span> <span class="nf">first_outer_callback</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;first outer callback, returning inner deferred&#39;</span>
    <span class="k">return</span> <span class="n">inner_d</span>

<span class="k">def</span> <span class="nf">second_outer_callback</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;second outer callback got:&#39;</span><span class="p">,</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">outer_errback</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;outer errback got:&#39;</span><span class="p">,</span> <span class="n">err</span>

<span class="n">outer_d</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">Deferred</span><span class="p">(</span><span class="n">cancel_outer</span><span class="p">)</span>
<span class="n">inner_d</span> <span class="o">=</span> <span class="n">defer</span><span class="o">.</span><span class="n">Deferred</span><span class="p">(</span><span class="n">cancel_inner</span><span class="p">)</span>

<span class="n">outer_d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">first_outer_callback</span><span class="p">)</span>
<span class="n">outer_d</span><span class="o">.</span><span class="n">addCallbacks</span><span class="p">(</span><span class="n">second_outer_callback</span><span class="p">,</span> <span class="n">outer_errback</span><span class="p">)</span>

<span class="n">outer_d</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="s">&#39;result&#39;</span><span class="p">)</span>

<span class="c"># at this point the outer deferred has fired, but is paused</span>
<span class="c"># on the inner deferred.</span>

<span class="k">print</span> <span class="s">&#39;canceling outer deferred.&#39;</span>
<span class="n">outer_d</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

<span class="k">print</span> <span class="s">&#39;done&#39;</span>
</pre></div>
</div>
<p>在这个例子中,我们创建了两个 <tt class="docutils literal"><span class="pre">deferred</span></tt>, <cite>outer</cite> 和 <cite>inner</cite>,并且有一个外部回调返回内部 <tt class="docutils literal"><span class="pre">deferred</span></tt>. 首先,我们激发外部 <tt class="docutils literal"><span class="pre">deferred</span></tt>,然后取消它. 输出结果如下:</p>
<div class="highlight-python"><pre>first outer callback, returning inner deferred
canceling outer deferred.
inner cancel callback.
outer errback got: [Failure instance: Traceback (failure with no frames): &lt;class 'twisted.internet.defer.CancelledError'&gt;:
]
done</pre>
</div>
<p>正如你看到的,取消外部 <tt class="docutils literal"><span class="pre">deferred</span></tt> 并没有使外部 <tt class="docutils literal"><span class="pre">cancel</span></tt> 回调被激发. 相反,它取消了内部 <tt class="docutils literal"><span class="pre">deferred</span></tt>,所以内部 <tt class="docutils literal"><span class="pre">cancel</span></tt> 回调被激发了,之后外部错误回调收到 <tt class="docutils literal"><span class="pre">CancelledError</span></tt> (来自内部 <tt class="docutils literal"><span class="pre">deferred</span></tt>).</p>
<p>你可能需要仔细看一看那些代码,并且做些变化看看如何影响结果.</p>
</div>
<div class="section" id="id11">
<h2>讨论<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h2>
<p>取消 <tt class="docutils literal"><span class="pre">deferred</span></tt> 是非常有用的操作,使我们的程序避免去做不需要的工作. 然而正如我们看到的,它可能有一点点棘手.</p>
<p>需要明白的一个重要事实是取消一个 <tt class="docutils literal"><span class="pre">deferred</span></tt> 并不意味着取消了它后面的异步操作.事实上,当写这篇文章时,很多 <tt class="docutils literal"><span class="pre">deferreds</span></tt> 并不会被真的&#8221;取消&#8221;,因为大部分Twisted代码写于Twisted 10.1.0之前并且还没有被升级.这包括很多Twisted本身的APIs！检查文档或源代码去发现&#8221;取消 <tt class="docutils literal"><span class="pre">deferred</span></tt>&#8220;是否真的取消了背后的请求,还是仅仅忽略它.</p>
<p>第二个重要事实是从你的异步APIs返回的 <tt class="docutils literal"><span class="pre">deferred</span></tt> 并不一定在完整意义上可取消. 如果你希望在自己的程序中实现取消,你应该先研究一下Twisted源代码中的许多例子. <tt class="docutils literal"><span class="pre">Cancellation</span></tt> 是一个暂新的特性,所以它的模式和最好实践还在制定当中.</p>
</div>
<div class="section" id="id12">
<h2>展望未来<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h2>
<p>现在我们已经学习了关于 <tt class="docutils literal"><span class="pre">Deferreds</span></tt> 的方方面面以及Twisted背后的核心概念. 这意味着我们没什么需要介绍的了,因为Twisted的其余部分主要包括一些特定的应用,如网络编程或异步数据库处理.故而,在 <a class="reference external" href="p20.html">接下来</a> 的部分中,我们想走点弯路,看看其他两个使用异步I/O的系统跟Twisted有何理念相似之处.之后,在尾声中,我们会打个包并且建议一些帮助你继续学习Twisted的方法.</p>
</div>
<div class="section" id="id14">
<h2>参考练习<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h2>
<ol class="arabic simple">
<li>你知道你可以用多种方式拼写&#8221;<cite>cancelled</cite>&#8220;吗? <a class="reference external" href="http://mw4.m-w.com/dictionary/canceled">真的</a>. 这取决于你的心情.</li>
<li>细读 <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/twisted/internet/defer.py#L167">Deferred</a> 类的源代码,关注 <tt class="docutils literal"><span class="pre">cancellation</span></tt> 的实现.</li>
<li>在Twisted 10.1.0的 <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.1.0/">源码</a> 中找具有取消回调的 <tt class="docutils literal"><span class="pre">deferred</span></tt> 的例子.研究它们的实现.</li>
<li>修改我们诗歌客户端中 <cite>get_poetry</cite> 方法返回的 <tt class="docutils literal"><span class="pre">deferred</span></tt>, 使其可取消.</li>
<li>做一个基于 <cite>reactor</cite> 的例子展示取消外部 <tt class="docutils literal"><span class="pre">deferred</span></tt>,它被内层 <tt class="docutils literal"><span class="pre">deferred</span></tt> 暂停了.如果使用 <tt class="docutils literal"><span class="pre">callLater</span></tt> 你需要小心选择延迟时间,以确保外层 <tt class="docutils literal"><span class="pre">deferred</span></tt> 在正确的时刻被取消.</li>
<li>找一个 Twisted 中还不支持&#8221;本质上取消操作&#8221;的异步API,为它实现本质取消. 并向 Twisted项目 提交一个 <a class="reference external" href="http://twistedmatrix.com/trac/wiki/BasicGuideToContributingCode">补丁</a>.不要忘记单元测试!</li>
</ol>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="p18.html">第十八部分 Deferreds 全貌</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">目录</a>
        &#160;&#160;::&#160;&#160;
        <a href="p20.html">第二十部分 轮子中的轮子: Twisted和Erlang</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; 版权所有 2011, Cheng Luo.
      最后更新日期是 Sep 04, 2013.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>