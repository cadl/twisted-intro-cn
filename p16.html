<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>第十六部分 Twisted 进程守护 &mdash; Twisted 入门|Twisted Introduction</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="top" title="Twisted 入门|Twisted Introduction" href="index.html" />
    <link rel="next" title="第十七部分 构造”回调”的另一种方法" href="p17.html" />
    <link rel="prev" title="第十五部分 测试诗歌" href="p15.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>Twisted Introduction</span></a></h1>
        <h2 class="heading"><span>第十六部分 Twisted 进程守护</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="p15.html">第十五部分 测试诗歌</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">目录</a>
        &#160;&#160;::&#160;&#160;
        <a href="p17.html">第十七部分 构造&#8221;回调&#8221;的另一种方法</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="twisted">
<h1>第十六部分 Twisted 进程守护<a class="headerlink" href="#twisted" title="永久链接至标题">¶</a></h1>
<p>你可以从&#8221;<a class="reference internal" href="p01.html"><em>第一部分 Twist理论基础</em></a>&#8220;开始阅读；也可以浏览&#8221;<a class="reference internal" href="index.html"><em>Twisted 入门!</em></a>&#8220;的索引</p>
<div class="section" id="id1">
<h2>简介<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>目前我们所写的服务器仅仅运行在终端窗口，结果通过 <tt class="docutils literal"><span class="pre">print</span></tt> 语句输出到屏幕.这对于开发来说已经足够，但对于产品级的部署还远远不够. 健壮的产品级服务器应该：</p>
<ol class="arabic simple">
<li>运行一个 <a class="reference external" href="http://en.wikipedia.org/wiki/Daemon_%28computer_software%29">daemon</a> 进程,这个进程不与任何终端或用户会话相关.因为没有人愿意当某用户登出时服务自动关闭.</li>
<li>将调试和错误信息发送到一系列滚转日志文件, 或者 <a class="reference external" href="http://en.wikipedia.org/wiki/Syslog">syslog</a> 服务.</li>
<li>放弃过高的权限,比如,在运行前切换到较低权限.</li>
<li>保存它的 <a class="reference external" href="http://en.wikipedia.org/wiki/Process_ID">pid</a> 文件以便管理员方便地向 daemon  <a class="reference external" href="http://en.wikipedia.org/wiki/Kill%28%29">发送信号</a>.</li>
</ol>
<p>我们可以利用Twisted提供的 <tt class="docutils literal"><span class="pre">twistd</span></tt> 脚本获得所有以上功能. 但是首先需要稍稍修改我们的代码.</p>
</div>
<div class="section" id="iservice">
<h2>IService<a class="headerlink" href="#iservice" title="永久链接至标题">¶</a></h2>
<p><a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L87">IService</a> 接口定义了一个可以启动或停止的服务. 这个服务究竟做了些什么? 答案是任何你喜欢的事情——这个接口只需要自提供的一些通用属性和方法,无须用户定义特定的函数.</p>
<p>这边有两个需要的属性: <tt class="docutils literal"><span class="pre">name</span></tt> 和 <tt class="docutils literal"><span class="pre">running</span></tt>.其中 <tt class="docutils literal"><span class="pre">name</span></tt> 属性是一个字符串,如 &#8220;<cite>fastpoetry</cite>&#8221;,或者 <cite>None</cite> 如果你不想给这个服务起名字. <tt class="docutils literal"><span class="pre">running</span></tt> 属性是 <strong>Boolean</strong> 变量,如果服务成功启动,值为 <cite>True</cite>.</p>
<p>下面我们只涉及 <tt class="docutils literal"><span class="pre">IService</span></tt> 的某些方法, 跳过那些很显然的或者在更简单的Twisted程序中用不到的高级方法. <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L130">startService</a> 和 <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L135">stopService</a> 是 <tt class="docutils literal"><span class="pre">IService</span></tt> 的两个关键方法：</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">startService</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start the service.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">stopService</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stop the service.</span>

<span class="sd">    @rtype: L{Deferred}</span>
<span class="sd">    @return: a L{Deferred} which is triggered when the service has</span>
<span class="sd">        finished shutting down. If shutting down is immediate, a</span>
<span class="sd">        value can be returned (usually, C{None}).</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>同样,这些方法做什么取决于服务的需求,比如 <tt class="docutils literal"><span class="pre">startService</span></tt> 可能会:</p>
<ul class="simple">
<li>加载配置数据,或</li>
<li>初始化数据库,或</li>
<li>开始监听某端口,或</li>
<li>什么也不做.</li>
</ul>
<p><tt class="docutils literal"><span class="pre">stopService</span></tt> 可能会:</p>
<ul class="simple">
<li>储存状态,或</li>
<li>关闭打开的数据库连接,或</li>
<li>停止监听某端口,或</li>
<li>什么也不做.</li>
</ul>
<p>当我们写自定义服务时, 要恰当地实现这些方法.对于一些通用的行为,比如监听某端口,Twisted提供了现成的服务可以使用.</p>
<p>注意 <tt class="docutils literal"><span class="pre">stopService</span></tt> 可以选择地返回 <cite>deferred</cite>,要求当服务完全关闭时被激发.这允许我们的服务在结束之后与整个程序终止之前完成清理工作.如果你需要服务立即关闭,可以仅仅返回 <cite>None</cite> 而不是 <cite>deferred</cite>.</p>
<p>服务可以被组织成集合以便一起启动和停止.下面来看看这里最后一个 <tt class="docutils literal"><span class="pre">IService</span></tt> 方法: <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L107">setServiceParent</a>,它添加一个服务到集合:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">setServiceParent</span><span class="p">(</span><span class="n">parent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the parent of the service.</span>

<span class="sd">    @type parent: L{IServiceCollection}</span>
<span class="sd">    @raise RuntimeError: Raised if the service already has a parent</span>
<span class="sd">        or if the service has a name and the parent already has a child</span>
<span class="sd">        by that name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
<p>任何服务都可以有双亲,这意味着服务可以被组织为层级结构.这把我们引向了今天讨论的另一个接口.</p>
</div>
<div class="section" id="iservicecollection">
<h2>IServiceCollection<a class="headerlink" href="#iservicecollection" title="永久链接至标题">¶</a></h2>
<p><a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L203">IServiceCollection</a> 接口定义了一个对象，它可包含若干个 <tt class="docutils literal"><span class="pre">IService</span></tt> 对象.一个服务集合仅仅是一个普通的类容器,具有以下方法:</p>
<ul class="simple">
<li>通过名字查找某服务( <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L212">getServiceNamed</a> )</li>
<li>遍历集合中的服务( <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L222">__iter__</a>)</li>
<li>添加一个服务到集合( <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L227">addService</a>)</li>
<li>从集合中移除一个服务( <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L236">removeService</a>)</li>
</ul>
</div>
<div class="section" id="application">
<h2>Application<a class="headerlink" href="#application" title="永久链接至标题">¶</a></h2>
<p>一个Twisted <tt class="docutils literal"><span class="pre">Application</span></tt> 不是通过一个单独的接口定义的.相反, <tt class="docutils literal"><span class="pre">Application</span></tt> 对象需要实现 <tt class="docutils literal"><span class="pre">IService</span></tt> 和 <tt class="docutils literal"><span class="pre">IServiceCollection</span></tt> 接口以及一些我们未曾涉及的接口.</p>
<p><tt class="docutils literal"><span class="pre">Application</span></tt> 是一个代表你整个Twisted应用的最顶层的服务. 在你 <tt class="docutils literal"><span class="pre">daemon</span></tt> 中的所有其他服务将是这个 <tt class="docutils literal"><span class="pre">Application</span></tt> 对象的儿子(甚至孙子,等等.).</p>
<p>其实需要你自己实现 <tt class="docutils literal"><span class="pre">Application</span></tt> 的机会很小,Twisted已经提供了一个当下常用的实现.</p>
</div>
<div class="section" id="twisted-logging">
<h2>Twisted Logging<a class="headerlink" href="#twisted-logging" title="永久链接至标题">¶</a></h2>
<p>Twisted在其模块 <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/python/log.py">twistd.python.log</a> 中包含了其自身的日志架构.由于写日志的基本 <strong>API</strong> 非常简单, 我们仅仅介绍一个小例子： <cite>basic-twisted/log.py</cite>,如果你感兴趣更多细节可以浏览Twisted模块.</p>
<p>我们也不详细介绍安装日志处理程序的 <strong>API</strong>,因为 <cite>twistd</cite> 脚本会帮我们做.</p>
</div>
<div class="section" id="fastpoetry-2-0">
<h2>FastPoetry 2.0<a class="headerlink" href="#fastpoetry-2-0" title="永久链接至标题">¶</a></h2>
<p>好吧,让我们看看代码.我们已经将快诗服务器升级为使用 <cite>twistd</cite>. 源码在 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-3/fastpoetry.py#L1">twisted-server-3/fastpoetry.py</a>. 首先我们有了 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-3/fastpoetry.py#L9">诗歌协议</a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PoetryProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">poem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">poem</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;sending </span><span class="si">%d</span><span class="s"> bytes of poetry to </span><span class="si">%s</span><span class="s">&#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">poem</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">getPeer</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">poem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>
</pre></div>
</div>
<p>注意没有使用 <tt class="docutils literal"><span class="pre">print</span></tt> 语句,而是使用 <tt class="docutils literal"><span class="pre">twisted.python.log.msg</span></tt> 函数去记录每个新连接.</p>
<p>这里是 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-3/fastpoetry.py#L19">工厂类</a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PoetryFactory</span><span class="p">(</span><span class="n">ServerFactory</span><span class="p">):</span>

      <span class="n">protocol</span> <span class="o">=</span> <span class="n">PoetryProtocol</span>

      <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">service</span>
</pre></div>
</div>
<p>正如你看到的，诗不再储存在工厂中，而是储存在一个被工厂引用的服务对象上。注意这边协议是如何通过工厂从服务获得诗歌.最后,看一下 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-3/fastpoetry.py#L27">服务类</a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PoetryService</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poetry_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poetry_file</span> <span class="o">=</span> <span class="n">poetry_file</span>

        <span class="k">def</span> <span class="nf">startService</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">startService</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poem</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poetry_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&#39;loaded a poem from: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poetry_file</span><span class="p">,))</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">就像许多其他接口类一样,Twisted提供了一个基类供自定义实现,同时具有方便的默认行为.</div>
<div class="line">我们使用 <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/application/service.py#L154">twisted.application.service.Service</a> 类实现 <tt class="docutils literal"><span class="pre">PoetryService</span></tt>.</div>
</div>
<p>这个基类提供了所有必要方法的默认实现,所以我们只需要实现个性化的行为.在上面的例子中,我们只重载了 <tt class="docutils literal"><span class="pre">startService</span></tt> 方法来加载诗歌文件.注:我们仍然调用了相应的基类方法(它为我们设置 <tt class="docutils literal"><span class="pre">running</span></tt> 属性).</p>
<p>另外值得一提的是： <tt class="docutils literal"><span class="pre">PoetryService</span></tt> 对象不知道关于 <tt class="docutils literal"><span class="pre">PoetryProtocol</span></tt> 的任何细节.这里服务的任务仅仅是加载诗歌以及为其他需要诗歌的对象提供接口.也就是说, <tt class="docutils literal"><span class="pre">PoetryService</span></tt> 只关心提供诗歌的更高层的细节,而不是关心诸如通过 <strong>TCP</strong> 连接发送诗歌这样的更底层的细节.所以同样的服务可以被另外的协议使用,如 <strong>UDP</strong> 或 <strong>XML-RPC</strong>.虽然对于简单的服务好处不大,但你可以想象其在更实际服务实现中的优势.</p>
<p>如果这是一个典型的Twisted程序,到目前我们看到的代码都不该出现在这个文件里.它们应该在一些模块当中(也许是 <tt class="docutils literal"><span class="pre">fastpoetry</span></tt> 和 <tt class="docutils literal"><span class="pre">fastpoetry.service</span></tt>).但是,遵循我们的惯例会使这些例子自包含,也就是在一个脚本中包含了所有东西.</p>
</div>
<div class="section" id="twisted-tac-files">
<h2>Twisted tac files<a class="headerlink" href="#twisted-tac-files" title="永久链接至标题">¶</a></h2>
<p>这个脚本的其余部分包含通常作为完整内容的 <tt class="docutils literal"><span class="pre">Twisted</span> <span class="pre">tac</span></tt> 文件. <tt class="docutils literal"><span class="pre">tac</span></tt> 文件是一个 <tt class="docutils literal"><span class="pre">Twisted</span> <span class="pre">Application</span> <span class="pre">Configuration</span></tt> 文件,它告诉 <tt class="docutils literal"><span class="pre">twistd</span></tt> 怎样去构建一个应用.作为一个配置文件,它负责选择设置(如端口,诗歌文件位置,等)来以一种特定的方式运行这个应用.换句话说, <tt class="docutils literal"><span class="pre">tac</span></tt> 代表我们服务的一个特定部署(在这个端口服务这首诗),而不是启动任何诗歌服务的一般脚本.</p>
<p>如果我们在同一个域运行多个诗歌服务,我们将为每一个服务准备一个 <tt class="docutils literal"><span class="pre">tac</span></tt> 文件(因此你可以明白为什么 <tt class="docutils literal"><span class="pre">tac</span></tt> 文件通常不包含任何一般目的的代码).在我们的例子中, <tt class="docutils literal"><span class="pre">tac</span></tt> 文件被配置为使 <tt class="docutils literal"><span class="pre">poetry/ecstasy.txt</span></tt> 运行在回环接口的10000号端口:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># configuration parameters</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">iface</span> <span class="o">=</span> <span class="s">&#39;localhost&#39;</span>
<span class="n">poetry_file</span> <span class="o">=</span> <span class="s">&#39;poetry/ecstasy.txt&#39;</span>
</pre></div>
</div>
<p>注意 <tt class="docutils literal"><span class="pre">twistd</span></tt> 并不知道这些特定变量,我们仅仅将这些配置值统一的放在这里.事实上, <tt class="docutils literal"><span class="pre">twistd</span></tt> 只关心整个文件中的一个变量,我们即将看到.下面我们开始建立我们的应用:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># this will hold the services that combine to form the poetry server</span>
<span class="n">top_service</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">MultiService</span><span class="p">()</span>
</pre></div>
</div>
<p>我们的诗歌服务器将包含两个服务, 上文定义的 <tt class="docutils literal"><span class="pre">PoetryService</span></tt>,和一个Twisted的内置服务,它将建立服务我们诗歌的监听套接字.由于这两个服务明显的相关,我们用 <tt class="docutils literal"><span class="pre">MultiService</span></tt> 将它们组织在一起,一个实现 <tt class="docutils literal"><span class="pre">IServiceCollection</span></tt> 和 <tt class="docutils literal"><span class="pre">IService</span></tt> 的类.</p>
<p>作为一个服务集合, <tt class="docutils literal"><span class="pre">MultiService</span></tt> 把我们的诗歌服务组织在一起.同时作为一个服务, <tt class="docutils literal"><span class="pre">MultiService</span></tt> 启动时将启动它的子服务,关闭时将关闭它的子服务.让我们向服务集合 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/twisted-server-3/fastpoetry.py#L48">添加</a> 第一个诗歌服务:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the poetry service holds the poem. it will load the poem when it is</span>
<span class="c"># started</span>
<span class="n">poetry_service</span> <span class="o">=</span> <span class="n">PoetryService</span><span class="p">(</span><span class="n">poetry_file</span><span class="p">)</span>
<span class="n">poetry_service</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">top_service</span><span class="p">)</span>
</pre></div>
</div>
<p>这是非常简单的内容.我们仅创建了 <tt class="docutils literal"><span class="pre">PoetryService</span></tt>,然后用 <tt class="docutils literal"><span class="pre">setServiceParent</span></tt> 方法将其添加到服务集合.下面我们添加 <strong>TCP</strong> 监听器:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># the tcp service connects the factory to a listening socket. it will</span>
<span class="c"># create the listening socket when it is started</span>
<span class="n">factory</span> <span class="o">=</span> <span class="n">PoetryFactory</span><span class="p">(</span><span class="n">poetry_service</span><span class="p">)</span>
<span class="n">tcp_service</span> <span class="o">=</span> <span class="n">internet</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">interface</span><span class="o">=</span><span class="n">iface</span><span class="p">)</span>
<span class="n">tcp_service</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">top_service</span><span class="p">)</span>
</pre></div>
</div>
<p>Twisted为创建连接到任意工厂的 <strong>TCP</strong> 监听套接字提供了 <tt class="docutils literal"><span class="pre">TCPServer</span></tt> 服务(这里是 <tt class="docutils literal"><span class="pre">PoetryFactory</span></tt>),我们没有直接调用 <tt class="docutils literal"><span class="pre">reactor.listenTCP</span></tt> 因为 <tt class="docutils literal"><span class="pre">tac</span></tt> 文件的工作是使我们的应用准备好开始,而不是实际启动它. 这里 <tt class="docutils literal"><span class="pre">TCPServer</span></tt> 将在被 <tt class="docutils literal"><span class="pre">twistd</span></tt> 启动后创建套接字.</p>
<p>你可能注意到我们没有为任何服务起名字.为服务起名不是必需的,而仅是一个可选项,如果你希望在运行时查找服务.因为我们不需要这个功能,所以这里没有为服务命名.</p>
<p>既然我们已经将两个服务绑定到服务集合.现只需创建我们的应用,并且将它添加到集合:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># this variable has to be named &#39;application&#39;</span>
<span class="n">application</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="s">&quot;fastpoetry&quot;</span><span class="p">)</span>

<span class="c"># this hooks the collection we made to the application</span>
<span class="n">top_service</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
</pre></div>
</div>
<p>在这个脚本中 <tt class="docutils literal"><span class="pre">twistd</span></tt> 所关心的唯一变量就是 <cite>application</cite>. <tt class="docutils literal"><span class="pre">twistd</span></tt> 正是通过它找到那个需要启动的应用(所以这个变量必须被命名为 <cite>applicaton</cite>).当应用被启动时,我们添加到它的所有服务都会被启动.</p>
<p>图34显示了我们刚刚建立的应用的结构:</p>
<div class="figure" id="figure34">
<img alt="_images/p16_application.png" src="_images/p16_application.png" />
</div>
<div class="line-block">
<div class="line">图34: fastpoetry 应用的结构图</div>
</div>
</div>
<div class="section" id="running-the-server">
<h2>Running the Server<a class="headerlink" href="#running-the-server" title="永久链接至标题">¶</a></h2>
<p>让我们的新服务器运转起来.作为 <tt class="docutils literal"><span class="pre">tac</span></tt> 文件,我们需要用 <tt class="docutils literal"><span class="pre">twistd</span></tt> 启动它.当然,它仅仅是一个普通的Python文件.所以我们首先用 <tt class="docutils literal"><span class="pre">python</span></tt> 命令启动,再看看会发生什么:</p>
<div class="highlight-python"><pre>python twisted-server-3/fastpoetry.py</pre>
</div>
<p>如果你这样做,会发现什么也没有发生！正如前文所述, <tt class="docutils literal"><span class="pre">tac</span></tt> 文件的工作是使我们的应用准备好运行,而不是实际运行它.作为 <tt class="docutils literal"><span class="pre">tac</span></tt> 文件这个特殊目的的提醒,人们将它的扩展名规定为 <cite>.tac</cite> 而不是 <cite>.py</cite>.但是 <tt class="docutils literal"><span class="pre">twistd</span></tt> 脚本实际并不区分扩展名.</p>
<p>让我们用 <tt class="docutils literal"><span class="pre">twistd</span></tt> 脚本来实际运行这个服务器:</p>
<div class="highlight-python"><pre>twistd --nodaemon --python twisted-server-3/fastpoetry.py</pre>
</div>
<p>运行以上命令后会看到如下输出:</p>
<div class="highlight-python"><pre>2010-06-23 20:57:14-0700 [-] Log opened.
2010-06-23 20:57:14-0700 [-] twistd 10.0.0 (/usr/bin/python 2.6.5) starting up.
2010-06-23 20:57:14-0700 [-] reactor class: twisted.internet.selectreactor.SelectReactor.
2010-06-23 20:57:14-0700 [-] __builtin__.PoetryFactory starting on 10000
2010-06-23 20:57:14-0700 [-] Starting factory &lt;__builtin__.PoetryFactory instance at 0x14ae8c0&gt;
2010-06-23 20:57:14-0700 [-] loaded a poem from: poetry/ecstasy.txt</pre>
</div>
<p>需要注意的几点:</p>
<ol class="arabic simple">
<li>你可以看到Twisted日志系统的输出, 包括 <tt class="docutils literal"><span class="pre">PoetryFactory</span></tt> 调用 <tt class="docutils literal"><span class="pre">log.msg</span></tt>.但是我们在 <tt class="docutils literal"><span class="pre">tac</span></tt> 文件中没有安装 <tt class="docutils literal"><span class="pre">logger</span></tt>, 所以 <tt class="docutils literal"><span class="pre">twistd</span></tt> 会帮我们安装.</li>
<li>你可以看到我们的两个主要服务 <tt class="docutils literal"><span class="pre">PoetryService</span></tt> 和 <tt class="docutils literal"><span class="pre">TCPServer</span></tt> 启动了.</li>
<li>shell提示符不会返回. 这表明我们的服务器没有以守护进程方式运行. 默认地, <tt class="docutils literal"><span class="pre">twistd</span></tt> 会以守护进程方式运行服务器(这正是 <tt class="docutils literal"><span class="pre">twistd</span></tt> 存在的原因), 但是如果你包含&#8221;<tt class="docutils literal"><span class="pre">--nodaemon</span></tt>&#8221; 选项,那么 <tt class="docutils literal"><span class="pre">twistd</span></tt> 将以一个常规shell进程的方式运行你的服务器,同时会将日志输出导向到标准输出. 这对于调试 <tt class="docutils literal"><span class="pre">tac</span></tt> 文件非常有用.</li>
</ol>
<p>下面测试取诗服务器, 通过我们的诗歌代理或者 <tt class="docutils literal"><span class="pre">netcat</span></tt> 命令:</p>
<div class="highlight-python"><pre>netcat localhost 10000</pre>
</div>
<p>这将从服务器抓取诗歌,并且你可以看到一行如下的日志:</p>
<div class="highlight-python"><pre>2010-06-27 22:17:39-0700 [__builtin__.PoetryFactory] sending 3003 bytes of poetry to IPv4Address(TCP, '127.0.0.1', 58208)</pre>
</div>
<p>这个日志来自 <tt class="docutils literal"><span class="pre">PoetryProtocol.connectionMade</span></tt> 方法调用 <tt class="docutils literal"><span class="pre">log.msg</span></tt>.当你向服务器发送更多请求时, 你将看到更多的日志条目.</p>
<p>现在可以用 <tt class="docutils literal"><span class="pre">Ctrl-C</span></tt> 来终止这个服务器. 你可以看到如下输出:</p>
<div class="highlight-python"><pre>^C2010-06-29 21:32:59-0700 [-] Received SIGINT, shutting down.
2010-06-29 21:32:59-0700 [-] (Port 10000 Closed)
2010-06-29 21:32:59-0700 [-] Stopping factory &lt;__builtin__.PoetryFactory instance at 0x28d38c0&gt;
2010-06-29 21:32:59-0700 [-] Main loop terminated.
2010-06-29 21:32:59-0700 [-] Server Shut Down.</pre>
</div>
<p>正如你看到的, Twisted并没有简单地崩溃, 而是优雅地关闭并将日志信息告诉你.</p>
<p>好啦, 现在再次启动服务器:</p>
<div class="highlight-python"><pre>twistd --nodaemon --python twisted-server-3/fastpoetry.py</pre>
</div>
<p>现在打开另一个shell并切换到 <tt class="docutils literal"><span class="pre">twisted-intro</span></tt> 目录. 其中有一个叫 <cite>twistd.pid</cite> 的文件. 它是被 <tt class="docutils literal"><span class="pre">twistd</span></tt> 创建的, 包含我们这个运行服务器进程号. 试一下下面的方法来关闭服务器:</p>
<div class="highlight-python"><pre>kill `cat twistd.pid`</pre>
</div>
<p>注意当服务器关闭后, <cite>twistd.pid</cite> 文件消失了, 它被 <tt class="docutils literal"><span class="pre">twistd</span></tt> 清理了.</p>
</div>
<div class="section" id="a-real-daemon">
<h2>A Real Daemon<a class="headerlink" href="#a-real-daemon" title="永久链接至标题">¶</a></h2>
<p>现在让我们以守护进程的方式启动服务器, 这是 <tt class="docutils literal"><span class="pre">twistd</span></tt> 的默认方式:</p>
<div class="highlight-python"><pre>twistd --python twisted-server-3/fastpoetry.py</pre>
</div>
<p>这次我们立即看到shell提示符返回. 当你列出目录中的文件时,会发现除了 <cite>twistd.pid</cite> 文件,又出现了 <cite>twistd.log</cite> 文件,它记录了之前显示在shell窗口的日志信息.</p>
<p>当启动一个守护进程时, <tt class="docutils literal"><span class="pre">twistd</span></tt> 安装一个日志管理器将条目写入一个文件而不是标准输出. 默认的日志文件是 <cite>twistd.log</cite>, 它出现在你运行 <tt class="docutils literal"><span class="pre">twistd</span></tt> 的目录中,但是你可以通过&#8221;<tt class="docutils literal"><span class="pre">--logfile</span></tt>&#8220;来改变它的位置. <tt class="docutils literal"><span class="pre">twistd</span></tt> 安装的的日志管理器将滚动输出日志信息, 确保其不超过 <cite>1M</cite>.</p>
<p>你可以通过列出操作系统上的所有进程来查看正在运行的服务器. 你不妨通过取另一首诗来测试这个服务器. 你可以看到记录每个诗歌请求的新条目出现在日志文件中.</p>
<p>由于这个服务器不再与shell相连(或者除了 <a class="reference external" href="http://en.wikipedia.org/wiki/Init">init</a> 的任何其他进程), 你不能通过 <tt class="docutils literal"><span class="pre">Ctrl-C</span></tt> 关闭它. 作为一个真的守护进程, 即使你登出它也继续运行.但是你可以通过 <cite>twistd.pid</cite> 文件终止这个进程:</p>
<div class="highlight-python"><pre>kill `cat twistd.pid`</pre>
</div>
<p>随后, 关闭消息出现在日志文件中, <tt class="docutils literal"><span class="pre">twistd.pid</span></tt> 文件被移除, 服务器停止.</p>
<p>检查一下其他的 <tt class="docutils literal"><span class="pre">twistd</span></tt> 启动选项是个不错的主意. 例如,你可以告诉 <tt class="docutils literal"><span class="pre">twistd</span></tt> 在启动进程守护前切换到另一个用户或组账户(是一种当你的服务器不需要安全防范措施取消权限的典型方法). 我们就不进一步探讨那些额外的选项了,你可以通过 <tt class="docutils literal"><span class="pre">twistd</span></tt> 的 <tt class="docutils literal"><span class="pre">--help</span></tt> 自己研究它们.</p>
<div class="section" id="id9">
<h3>Twisted 插件系统<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<p>现在我们已经通过 <tt class="docutils literal"><span class="pre">twistd</span></tt> 启动真正的守护进程服务器. 这非常完美,而且事实上我们的配置文件是纯Python源码文件,这一点为我们设置带来巨大便利. 但是我们有时用不到这样的便利性.对于诗歌服务器,我们通常只关心一小部分选项:</p>
<ol class="arabic simple">
<li>需要服务的诗歌</li>
<li>服务端口</li>
<li>监听接口</li>
</ol>
<p>为了几个简单的变量建立一个 <tt class="docutils literal"><span class="pre">tac</span></tt> 文件显得有点小题大做. 如果我们能够通过 <tt class="docutils literal"><span class="pre">twistd</span></tt> 选项指定这些值将非常方便. Twisted的插件系统允许我们可以这样做.</p>
<p>Twisted插件通过定义 <tt class="docutils literal"><span class="pre">Application</span></tt> 提供了一种方法, 可以实现个性化的命令行选项, 进而 <tt class="docutils literal"><span class="pre">twistd</span></tt> 动态的发现和运行. Twisted本身具有一套插件,你可以通过运行不带参数的 <tt class="docutils literal"><span class="pre">twistd</span></tt> 命令来查看它们. 现在就试一试, 在 <tt class="docutils literal"><span class="pre">twisted-intro</span></tt> 目录外. 在帮助部分后面,你可以看到如下输出:</p>
<div class="highlight-python"><pre>...
ftp                An FTP server.
telnet             A simple, telnet-based remote debugging service.
socks              A SOCKSv4 proxy service.
...</pre>
</div>
<div class="line-block">
<div class="line">每一行显示了一个Twisted内置的插件, 你可以用 <tt class="docutils literal"><span class="pre">twistd</span></tt> 运行它们.</div>
<div class="line">每个插件同样有它们自己的选项,你可以通过 <tt class="docutils literal"><span class="pre">--help</span></tt> 来发现它们. 让我们看看 <tt class="docutils literal"><span class="pre">ftp</span></tt> 插件有什么选项:</div>
</div>
<div class="highlight-python"><pre>twistd ftp --help</pre>
</div>
<p>注意我们需要将 <tt class="docutils literal"><span class="pre">--help</span></tt> 放在 <tt class="docutils literal"><span class="pre">ftp</span></tt> 后面而不是 <tt class="docutils literal"><span class="pre">twistd</span></tt> 后面, 因为我们想得到 <tt class="docutils literal"><span class="pre">ftp</span></tt> 的可选项.</p>
<p>我们可以像运行诗歌服务器一样运行 <tt class="docutils literal"><span class="pre">ftp</span></tt> 服务器. 但由于它是一个插件,我们可以仅仅通过它的名字运行:</p>
<div class="highlight-python"><pre>twistd --nodaemon ftp --port 10001</pre>
</div>
<p>以上命令以非守护进程的方式在端口 <cite>10001</cite> 上运行 <tt class="docutils literal"><span class="pre">ftp</span></tt> 插件. 注意 <tt class="docutils literal"><span class="pre">twistd</span></tt> 的 <cite>nodaemon</cite> 选项出现在插件名字的前面,插件特定选项 <cite>port</cite> 出现在插件名字的后面. 正如我们的诗歌服务器一样,你可以用 <tt class="docutils literal"><span class="pre">Ctrl-C</span></tt> 停止它.</p>
<p>OK, 让我们把诗歌服务器转化为Twisted的插件. 首先我们需要介绍一些新概念.</p>
</div>
</div>
<div class="section" id="iplugin">
<h2>IPlugin<a class="headerlink" href="#iplugin" title="永久链接至标题">¶</a></h2>
<p>任何Twisted插件都需要实现 <a class="reference external" href="http://twistedmatrix.com/trac/browser/tags/releases/twisted-10.0.0/twisted/plugin.py#L38">twisted.plugin.IPlugin</a> 接口. 如果你浏览这个接口的声明, 你会发现它没有指定任何方法. 实现 <tt class="docutils literal"><span class="pre">IPlugin</span></tt> 接口仅仅相当于一个插件在说：&#8221;你好,我是插件！&#8221;以便 <tt class="docutils literal"><span class="pre">twistd</span></tt> 找到它. 当然,出于实用考虑,它需要实现一些其他接口,我们很快会介绍.</p>
<p>但是你怎样知道一个对象实现了一个空接口? <tt class="docutils literal"><span class="pre">zope.interface</span></tt> 包含了一个叫做 <cite>implements</cite> 的函数,它可以用来声明一个特定类实现了一个特定的接口. 我们将在插件版的诗歌服务器中看到这种使用.</p>
</div>
<div class="section" id="iservicemaker">
<h2>IServiceMaker<a class="headerlink" href="#iservicemaker" title="永久链接至标题">¶</a></h2>
<p>除了 <tt class="docutils literal"><span class="pre">IPlugin</span></tt>,我们的插件还实现 <tt class="docutils literal"><span class="pre">IServiceMaker</span></tt> 接口. 一个实现了 <tt class="docutils literal"><span class="pre">IServiceMaker</span></tt> 接口的对象知道如何创建 <tt class="docutils literal"><span class="pre">IService</span></tt>,它将成为运行程序的核心. <tt class="docutils literal"><span class="pre">IServiceMaker</span></tt> 指定了三个属性和一个方法:</p>
<ol class="arabic simple">
<li><cite>tapname</cite>: 代表插件名字的字符串. &#8220;<cite>tap</cite>&#8220;代表&#8221;Twisted Application Plugin&#8221;. 注:老版本的Twisted还使用&#8221;<cite>tapfiles</cite>&#8220;文件,不过这个功能现在已经取消了.</li>
<li><cite>description</cite>: 插件的描述, <tt class="docutils literal"><span class="pre">twistd</span></tt> 将以它作为帮助信息输出.</li>
<li><cite>options</cite>: 一个代表这个插件接受的命令行选项的对象.</li>
<li><cite>makeService</cite>: 一个创建 <tt class="docutils literal"><span class="pre">IService</span></tt> 对象的方法,需提供一些特定的命令行选项.</li>
</ol>
<p>我们将在下一个版本的诗歌服务器中看到怎样将上述内容组织在一起.</p>
<div class="section" id="fast-poetry-3-0">
<h3>Fast Poetry 3.0<a class="headerlink" href="#fast-poetry-3-0" title="永久链接至标题">¶</a></h3>
<p>现在我们已经为插件版本的&#8221;<cite>Fast Poetry</cite>&#8220;做好准备,它位于 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/twisted/plugins/fastpoetry_plugin.py#L1">twisted/plugins/fastpoetry_plugin.py</a>.</p>
<p>你可能注意到与其他例子不同, 我们命名了一个不同的目录. 这是因为 <tt class="docutils literal"><span class="pre">twistd</span></tt> 需要插件文件位于 <cite>twisted/plugins</cite> 目录中, 同时在你的Python搜索路径上. 这个目录不必是一个包(也就是, 不必包含任何 <cite>__init__.py</cite> 文件), 而且在路径上可以有多个 <cite>twisted/plugins</cite> 目录, <tt class="docutils literal"><span class="pre">twistd</span></tt> 都会找到它们. 这个插件的实际文件名是什么也没有关系, 但是一个好的方案是根据应用所代表的含义来命名, 就像我们在这里做的.</p>
<p>我们的插件开头部分同样包括诗歌协议,工厂,以及像 <tt class="docutils literal"><span class="pre">tac</span></tt> 文件中所实现的服务.如前所述,这些代码通常应该单独的存在于一个模块中,但出于我们例子自包含的目的,还是将它们放在插件文件中.</p>
<p>下面将 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/twisted/plugins/fastpoetry_plugin.py#L45">声明</a> 这个插件的命令行选项:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Options</span><span class="p">(</span><span class="n">usage</span><span class="o">.</span><span class="n">Options</span><span class="p">):</span>

      <span class="n">optParameters</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">,</span> <span class="s">&#39;p&#39;</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="s">&#39;The port number to listen on.&#39;</span><span class="p">],</span>
          <span class="p">[</span><span class="s">&#39;poem&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;The file containing the poem.&#39;</span><span class="p">],</span>
          <span class="p">[</span><span class="s">&#39;iface&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="s">&#39;The interface to listen on.&#39;</span><span class="p">],</span>
      <span class="p">]</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">以上代码指定可以放在 <tt class="docutils literal"><span class="pre">twistd</span></tt> 命令后面使用的插件特定选项的名字.</div>
<div class="line">这里就不必进一步解释上述选项的含义了,其含义很显然. 下面我们来看一下插件的主要部分 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/twisted/plugins/fastpoetry_plugin.py#L56">服务制造类</a>:</div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PoetryServiceMaker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

      <span class="n">implements</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">IServiceMaker</span><span class="p">,</span> <span class="n">IPlugin</span><span class="p">)</span>

      <span class="n">tapname</span> <span class="o">=</span> <span class="s">&quot;fastpoetry&quot;</span>
      <span class="n">description</span> <span class="o">=</span> <span class="s">&quot;A fast poetry service.&quot;</span>
      <span class="n">options</span> <span class="o">=</span> <span class="n">Options</span>

      <span class="k">def</span> <span class="nf">makeService</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
          <span class="n">top_service</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">MultiService</span><span class="p">()</span>

          <span class="n">poetry_service</span> <span class="o">=</span> <span class="n">PoetryService</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;poem&#39;</span><span class="p">])</span>
          <span class="n">poetry_service</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">top_service</span><span class="p">)</span>

          <span class="n">factory</span> <span class="o">=</span> <span class="n">PoetryFactory</span><span class="p">(</span><span class="n">poetry_service</span><span class="p">)</span>
          <span class="n">tcp_service</span> <span class="o">=</span> <span class="n">internet</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">]),</span> <span class="n">factory</span><span class="p">,</span>
                                 <span class="n">interface</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;iface&#39;</span><span class="p">])</span>

          <span class="n">tcp_service</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">top_service</span><span class="p">)</span>

          <span class="k">return</span> <span class="n">top_service</span>
</pre></div>
</div>
<p>这里你可以看到如何使用 <tt class="docutils literal"><span class="pre">zope.interface.implements</span></tt> 函数来声明我们的类同时实现 <tt class="docutils literal"><span class="pre">IServiceMaker</span></tt> 和 <tt class="docutils literal"><span class="pre">IPlugin</span></tt> 接口.</p>
<p>你应该从之前的 <tt class="docutils literal"><span class="pre">tac</span></tt> 文件辨认出 <tt class="docutils literal"><span class="pre">makeService</span></tt> 中的代码, 但是这次我们不需要自己建立一个 <cite>Application</cite> 对象, 我们仅仅创建并返回最顶层服务,这样我们的程序就可以运行, <tt class="docutils literal"><span class="pre">twistd</span></tt> 来处理其余的事情. 注意我们是如何使用 <cite>options</cite> 参数来提取插件传递给 <tt class="docutils literal"><span class="pre">twistd</span></tt> 的特定命令行选项.</p>
<p>定义了上述类, 还有 <a class="reference external" href="https://github.com/jdavisp3/twisted-intro/blob/master/twisted/plugins/fastpoetry_plugin.py#L81">一步</a> :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">service_maker</span> <span class="o">=</span> <span class="n">PoetryServiceMaker</span><span class="p">()</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">twistd</span></tt> 脚本会发现我们插件的实例并使用它构建最顶层服务. 与 <tt class="docutils literal"><span class="pre">tac</span></tt> 文件不同的是, 选择什么变量名没有关系, 关键是我们的对象实现了 <tt class="docutils literal"><span class="pre">IPlugin</span></tt> 和 <tt class="docutils literal"><span class="pre">IServiceMaker</span></tt> 接口.</p>
<p>既然已经创建了插件, 让我们运行它. 确保你位于 <cite>twisted-intro</cite> 目录中, 或者 <cite>twisted-intro</cite> 位于Python的搜索目录中. 下面单独运行 <tt class="docutils literal"><span class="pre">twistd</span></tt>,你会看到&#8221;<cite>fastpoetry</cite>&#8220;是列出的插件之一,后面显示插件文件中定义的描述文字.</p>
<p>你同样会注意到 <cite>twisted/plugins</cite> 目录中出现了一个 <cite>dropin.cache</cite> 的新文件. 这个文件由 <tt class="docutils literal"><span class="pre">twistd</span></tt> 创建, 用来加速后续扫描插件的.</p>
<p>现在让我们获取一些关于插件的帮助信息:</p>
<div class="highlight-python"><pre>twistd fastpoetry --help</pre>
</div>
<p>你可以看到关于 <cite>fastpoetry</cite> 插件选项的帮助性文字. 最后,运行这个插件:</p>
<div class="highlight-python"><pre>twistd fastpoetry --port 10000 --poem poetry/ecstasy.txt</pre>
</div>
<p>这将以守护进程方式启动 <cite>fastpoetry</cite> 服务器. 与前面例子一样, 你会在当期文件夹看到 <cite>twistd.pid</cite> 和 <cite>twistd.log</cite> 文件. 测试完我们的服务器, 用一下命令关闭:</p>
<div class="highlight-python"><pre>kill `cat twistd.pid`</pre>
</div>
<p>这就是如何制作Twisted插件的方法.</p>
</div>
<div class="section" id="id13">
<h3>总 结<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h3>
<p>在这个部分, 我们学习了将Twisted服务器转换到支持长时间运行的守护进程模式. 我们还涉及了Twisted日志系统以及如何使用 <tt class="docutils literal"><span class="pre">twistd</span></tt> 以守护进程模式启动一个Twisted应用程序, 即或者通过 <tt class="docutils literal"><span class="pre">tac</span></tt> 配置文件或者Twisted插件. 在 <cite>第十七部分 &lt;`p17</cite>&gt;`_ 部分, 我们将转向异步编程的更基本的主题和另外一种结构化Twisted回调函数的方法.</p>
</div>
<div class="section" id="id14">
<h3>参 考 练 习<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h3>
<ol class="arabic simple">
<li>修正 <tt class="docutils literal"><span class="pre">tac</span></tt> 文件以在另外一个端口服务另外一首诗. 使用另外一个 <tt class="docutils literal"><span class="pre">MultiService</span></tt> 对象以保持每首诗的服务是分离的.</li>
<li>创建一个新的 <tt class="docutils literal"><span class="pre">tac</span></tt> 文件来启动一个诗歌代理服务器.</li>
<li>修正插件文件使其可接受第二个可选诗歌文件和服务端口.</li>
<li>为诗歌代理服务器创建一个新的插件.</li>
</ol>
</div>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="p15.html">第十五部分 测试诗歌</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">目录</a>
        &#160;&#160;::&#160;&#160;
        <a href="p17.html">第十七部分 构造&#8221;回调&#8221;的另一种方法</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; 版权所有 2011, Cheng Luo.
      最后更新日期是 Sep 04, 2013.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>